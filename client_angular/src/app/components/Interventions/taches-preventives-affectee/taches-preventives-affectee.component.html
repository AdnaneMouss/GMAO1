<div class="container mx-auto p-8">
  <div class="bg-white shadow-lg rounded-xl overflow-hidden p-6">
    <h2 class="text-3xl font-semibold text-gray-800 mb-4">Gestion des Maintenances Préventives</h2>

    <!-- Message d'erreur -->
    <div *ngIf="errorMessage" class="bg-red-100 text-red-700 text-center p-4 rounded-md mb-6 shadow">
      {{ errorMessage }}
    </div>

    <!-- Conteneur des icônes -->
<div style="display: flex; align-items: center; gap: 15px;">
  <!-- Icône de chat -->
  <div class="chat-icon" (click)="navigateToChat()" style="cursor: pointer;">
    <div style="position: fixed; top: 20px; right: 20px; z-index: 1000; transform: translateX(-3cm);">
      <i class="fas fa-comments" style="font-size: 2rem; color: #4285f4;"></i>
    </div>
  </div>

  <!-- Icône de notification avec badge -->
 
</div>

<!-- Panneau de notifications -->




    <!-- Filtres -->


    <!-- Filtres avancés par date -->
<!-- Filtres avancés par date -->
<div class="flex flex-wrap gap-4 items-center mt-4">
  <button (click)="filtrerParDateAujourdhui()"
          class="px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600">
    Tâches d'aujourd'hui
  </button>

  <div class="flex items-center gap-2">
    <label class="text-sm text-gray-700">Du :</label>
    <input type="date" [(ngModel)]="dateDebutFiltre" class="border rounded px-2 py-1" />
    <label class="text-sm text-gray-700">Au :</label>
    <input type="date" [(ngModel)]="dateFinFiltre" class="border rounded px-2 py-1" />
    <button (click)="filtrerParPlageDate()"
            class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600">
      Filtrer
    </button>
  </div>

  <button (click)="resetFiltre()"
  class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-yelow-500 flex items-center gap-2">
<i class="fas fa-sync-alt"></i> Rafraîchir
</button>
</div>


    <div class="mb-6 flex flex-wrap gap-4 items-center">
      <select [(ngModel)]="selectedPriorite" (change)="filterMaintenancesByPriorite()"
              class="px-4 py-2 border rounded-md w-full md:w-auto">
        <option value="">Filtrer par priorité</option>
        <option value="FAIBLE">FAIBLE</option>
        <option value="NORMALE">NORMALE</option>
        <option value="URGENTE">URGENTE</option>
      </select>

      <select [(ngModel)]="selectedStatus" (change)="filterMaintenancesByStatus()"
              class="px-4 py-2 border rounded-md w-full md:w-auto">
        <option value="">Filtrer par statut</option>
        <option value="EN_ATTENTE">EN ATTENTE</option>
        <option value="EN_COURS">EN COURS</option>
        <option value="TERMINEE">TERMINEE</option>
        <option value="ANNULEE">ANNULEE</option>
      </select>
    </div>

    <!-- Tableau -->
    <div class="overflow-x-auto" *ngIf="filteredMaintenace.length > 0">
      <table class="min-w-full table-auto bg-white border-collapse">
        <thead class="bg-green-700 text-white">
          <tr>
            <th class="px-6 py-3 text-sm font-semibold">#</th>
            <th class="px-6 py-3 text-sm font-semibold">Groupe</th>
            <th class="px-6 py-3 text-sm font-semibold">Date Début</th>
            <th class="px-6 py-3 text-sm font-semibold">Date Fin</th>
            <th class="px-6 py-3 text-sm font-semibold">Statut</th>
            <th class="px-6 py-3 text-sm font-semibold">Priorité</th>
            <th class="px-6 py-3 text-sm font-semibold">Action</th>
            <th class="px-6 py-3 text-sm font-semibold">Type Maintenance</th>
            <th class="px-6 py-3 text-sm font-semibold">Durée</th>
            <th class="px-6 py-3 text-sm font-semibold">Emplacement</th>
            <th class="px-6 py-3 text-sm font-semibold">Date Répétition</th>
            <th class="px-6 py-3 text-sm font-semibold">Actions</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let maintenance of filteredMaintenace; let i = index">
    
            <!-- Cas : maintenance sans répétition -->
            <tr *ngIf="!maintenance.nextRepetitionDates || maintenance.nextRepetitionDates.length === 0"
                class="border-b hover:bg-gray-50">
              
              <td class="px-6 py-4">{{ i + 1 }}</td>
              
              <td class="px-6 py-4">
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold">
                  Maintenance {{ i + 1 }}
                </span>
                <!-- Indicateur de date -->
             
              </td>
              
              <td class="px-6 py-4">
                {{ maintenance.dateDebutPrevue | date:'dd/MM/yyyy' }}
                <!-- Alternative: Indicateur à côté de la date -->
                <span *ngIf="getDateStatus(maintenance.dateDebutPrevue) as dateStatus" 
                      class="ml-2 px-2 py-1 rounded-full text-xs font-semibold"
                      [ngClass]="{
                        'bg-orange-500 text-white': dateStatus === 'today',
                        'bg-yellow-500 text-white': dateStatus.startsWith('in')
                      }">
                  {{ getDateMessage(maintenance.dateDebutPrevue) }}
                </span>
              </td>
              
              <td class="px-6 py-4">{{ maintenance.dateFinPrevue | date:'dd/MM/yyyy' }}</td>
              
              <td class="px-6 py-4">
                <span class="px-3 py-1 rounded-full text-xs font-semibold"
                      [ngClass]="{
                        'bg-gray-200 text-gray-700': maintenance.statut === 'EN_ATTENTE',
                        'bg-yellow-300 text-yellow-800': maintenance.statut === 'EN_COURS',
                        'bg-green-300 text-green-800': maintenance.statut === 'TERMINEE',
                        'bg-red-300 text-red-800': maintenance.statut === 'ANNULEE'
                      }">
                  {{ maintenance.statut }}
                </span>
              </td>
              
              <td class="px-6 py-4">
                <span class="px-3 py-1 rounded-full text-xs font-semibold"
                      [ngClass]="{
                        'bg-green-500 text-white': maintenance.priorite === 'FAIBLE',
                        'bg-yellow-500 text-white': maintenance.priorite === 'NORMALE',
                        'bg-red-500 text-white': maintenance.priorite === 'URGENTE'
                      }">
                  {{ maintenance.priorite }}
                </span>
              </td>
              
              <td class="px-6 py-4">{{ maintenance.action }}</td>
              <td class="px-6 py-4">{{ maintenance.repetitiontype }}</td>
              <td class="px-6 py-4">{{ maintenance.dureeIntervention }}</td>
              <td class="px-6 py-4">Salle : {{ maintenance.salle?.num }}</td>
              
              <!-- Date répétition vide -->
              <td class="px-6 py-4 font-medium">—</td>
              
              <td class="px-6 py-4 text-sm">
                <ng-container *ngIf="maintenance.statut === 'EN_ATTENTE'">
                  <button (click)="openConfirmationDialog('start', maintenance.id)"
                          class="bg-blue-600 text-white p-3 rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105"
                          title="Commencer la tâche">
                    <i class="fas fa-play"></i>
                  </button>
                </ng-container>
                <ng-container *ngIf="maintenance.statut === 'EN_COURS'">
                  <button (click)="openConfirmationDialog('complete', maintenance.id)"
                          class="bg-green-600 text-white p-3 rounded-lg shadow-lg hover:bg-green-700 transition-all duration-300 transform hover:scale-105"
                          title="Marquer comme terminé">
                    <i class="fas fa-check"></i>
                  </button>
                </ng-container>
              </td>
            </tr>
    
            <!-- Cas : maintenance avec répétitions -->
            <tr *ngFor="let date of maintenance.nextRepetitionDates; let isFirst = first"
                class="border-b hover:bg-gray-50"
                [ngClass]="{ 'bg-gray-50': !isFirst }">
              
              <td class="px-6 py-4">{{ isFirst ? i + 1 : '' }}</td>
              
              <td class="px-6 py-4">
                <span *ngIf="isFirst" class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold">
                  Maintenance {{ i + 1 }}
                </span>
                <span *ngIf="!isFirst" class="text-gray-400 px-2 py-1 text-xs">↳</span>
                <!-- Indicateur de date -->
            
              </td>
              
              <td class="px-6 py-4">{{ maintenance.dateDebutPrevue | date:'dd/MM/yyyy' }}</td>
              <td class="px-6 py-4">{{ maintenance.dateFinPrevue | date:'dd/MM/yyyy' }}</td>
              
              <td class="px-6 py-4">
                <span class="px-3 py-1 rounded-full text-xs font-semibold"
                      [ngClass]="{
                        'bg-gray-200 text-gray-700': maintenance.statut === 'EN_ATTENTE',
                        'bg-yellow-300 text-yellow-800': maintenance.statut === 'EN_COURS',
                        'bg-green-300 text-green-800': maintenance.statut === 'TERMINEE',
                        'bg-red-300 text-red-800': maintenance.statut === 'ANNULEE'
                      }">
                  {{ maintenance.statut }}
                </span>
              </td>
              
              <td class="px-6 py-4">
                <span class="px-3 py-1 rounded-full text-xs font-semibold"
                      [ngClass]="{
                        'bg-green-500 text-white': maintenance.priorite === 'FAIBLE',
                        'bg-yellow-500 text-white': maintenance.priorite === 'NORMALE',
                        'bg-red-500 text-white': maintenance.priorite === 'URGENTE'
                      }">
                  {{ maintenance.priorite }}
                </span>
              </td>
              
              <td class="px-6 py-4">{{ maintenance.action }}</td>
              <td class="px-6 py-4">{{ maintenance.repetitiontype }}</td>
              <td class="px-6 py-4">{{ maintenance.dureeIntervention }}</td>
              <td class="px-6 py-4">Salle : {{ maintenance.salle?.num }}</td>
              
              <!-- Affichage de la date de répétition -->
              <td class="px-6 py-4 font-medium">
                {{ date | date:'dd/MM/yyyy' }}
                <!-- Alternative: Indicateur à côté de la date de répétition -->
                <span *ngIf="getDateStatus(date) as dateStatus" 
                      class="ml-2 px-2 py-1 rounded-full text-xs font-semibold"
                      [ngClass]="{
                        'bg-orange-500 text-white': dateStatus === 'today',
                        'bg-yellow-500 text-white': dateStatus.startsWith('in')
                      }">
                  {{ getDateMessage(date) }}
                </span>
              </td>
              
              <td class="px-6 py-4 text-sm">
                <ng-container *ngIf="maintenance.statut === 'EN_ATTENTE'">
                  <button (click)="openConfirmationDialog('start', maintenance.id)"
                          class="bg-blue-600 text-white p-3 rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105"
                          title="Commencer la tâche">
                    <i class="fas fa-play"></i>
                  </button>
                </ng-container>
                <ng-container *ngIf="maintenance.statut === 'EN_COURS'">
                  <button (click)="openConfirmationDialog('complete', maintenance.id)"
                          class="bg-green-600 text-white p-3 rounded-lg shadow-lg hover:bg-green-700 transition-all duration-300 transform hover:scale-105"
                          title="Marquer comme terminé">
                    <i class="fas fa-check"></i>
                  </button>
                </ng-container>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
    
    
    

    <!-- Pagination -->
    <div class="flex justify-between items-center mt-6">
      <div class="text-sm text-gray-600">
        Affichage de {{ (currentPage * pageSize) + 1 }} à 
        {{ getMin((currentPage + 1) * pageSize, filteredMaintenace.length) }}
        sur {{ filteredMaintenace.length }} éléments
      </div>
      <div class="flex gap-2">
        <button (click)="goToPage(0)" [disabled]="currentPage === 0"
                class="px-3 py-1 border rounded disabled:opacity-50">
          <i class="fas fa-angle-double-left"></i>
        </button>
        <button (click)="prevPage()" [disabled]="currentPage === 0"
                class="px-3 py-1 border rounded disabled:opacity-50">
          <i class="fas fa-angle-left"></i>
        </button>
        <span class="px-3 py-1">Page {{ currentPage + 1 }} / {{ getTotalPages() }}</span>
        <button (click)="nextPage()" [disabled]="currentPage >= getTotalPages() - 1"
                class="px-3 py-1 border rounded disabled:opacity-50">
          <i class="fas fa-angle-right"></i>
        </button>
        <button (click)="goToPage(getTotalPages() - 1)" [disabled]="currentPage >= getTotalPages() - 1"
                class="px-3 py-1 border rounded disabled:opacity-50">
          <i class="fas fa-angle-double-right"></i>
        </button>
      </div>
    </div>
  </div>
  <!-- Confirmation Dialog  -->
<div *ngIf="showConfirmation" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 max-w-md w-full">
    <h3 class="text-xl font-semibold mb-4">Confirmation</h3>
    <p class="mb-6">{{ confirmationMessage }}</p>
    <div class="flex justify-end gap-4">
      <button 
        (click)="cancelAction()"
        class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100"
      >
        Annuler
      </button>
      <button 
        (click)="confirmAction()"
        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
      >
        Confirmer
      </button>
    </div>
  </div>
</div>
</div>

<div *ngIf="showInterventionForm" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-1/3">
    <h3 class="text-xl font-semibold mb-4">Ajouter une intervention</h3>
    <form #form="ngForm" (ngSubmit)="submitIntervention()" novalidate>

      <!-- Description -->
      <div class="mb-4">
        <label for="interventionDescription" class="block text-sm font-medium text-gray-600">
          Description de l'intervention <span class="text-red-500">*</span>
        </label>
        <textarea
          id="interventionDescription"
          [(ngModel)]="intervention.description"
          name="interventionDescription"
          required
          #descRef="ngModel"
          rows="4"
          class="w-full p-2 border rounded mt-1"
          aria-describedby="descriptionHelp"></textarea>
        <small id="descriptionHelp" class="text-gray-500 text-xs">Décrivez l'intervention effectuée.</small>
        <div *ngIf="descRef.invalid && descRef.touched" class="text-red-500 text-sm mt-1">
          La description est obligatoire.
        </div>
      </div>

      <!-- Remarques -->
      <div class="mb-4">
        <label for="interventionRemarques" class="block text-sm font-medium text-gray-600">
          Remarques
        </label>
        <textarea
          id="interventionRemarques"
          [(ngModel)]="intervention.remarques"
          name="interventionRemarques"
          rows="3"
          class="w-full p-2 border rounded mt-1"
          aria-describedby="remarksHelp"></textarea>
        <small id="remarksHelp" class="text-gray-500 text-xs">Ajoutez des commentaires ou des informations supplémentaires.</small>
      </div>

      <div class="mb-4">
        <label for="piecesDetachees" class="block text-sm font-medium text-gray-600">
          Pièce détachée utilisée <span class="text-red-500">*</span>
        </label>
        <select
          id="piecesDetachees"
          name="piecesDetachees"
          [ngModel]="selectedPieces"
          (ngModelChange)="onPiecesChange($event)"
          required
          multiple
          #piecesRef="ngModel"
          class="w-full p-2 border rounded mt-1"
          aria-describedby="pieceDetacheeHelp"
        >
          <option *ngFor="let piece of piecesList" [ngValue]="piece.id">{{ piece.nom }}</option>
        </select>
        <small id="pieceDetacheeHelp" class="text-gray-500 text-xs">
          Entrez la pièce détachée utilisée lors de l'intervention.
        </small>
        <div *ngIf="piecesRef.invalid && piecesRef.touched" class="text-red-500 text-sm mt-1">
          Veuillez sélectionner au moins une pièce détachée.
        </div>
      </div>

      <!-- Photos -->
      <div class="mb-4">
        <label for="photos" class="block text-sm font-medium text-gray-600">
          Ajouter des photos <span class="text-red-500">*</span>
        </label>
        <input
          type="file"
          id="photos"
          name="photos"
          required
          (change)="onFileChange($event)"
          class="w-full p-2 border rounded mt-1"
          multiple
          accept="image/*"
          aria-describedby="photosHelp" />
        <small id="photosHelp" class="text-gray-500 text-xs">Sélectionnez plusieurs photos si nécessaire.</small>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-end space-x-4">
        <button
          type="submit"
          class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
          [disabled]="form.invalid">
          Ajouter l'intervention
        </button>
        <button
          (click)="cancelAction()"
          type="button"
          class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
          Annuler
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Font Awesome -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
/>
